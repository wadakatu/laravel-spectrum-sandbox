upstream sandbox_app {
    server sandbox-app:3001;
}

upstream laravel_10_terminal {
    server laravel-10:7010;
}

upstream laravel_11_terminal {
    server laravel-11:7011;
}

upstream laravel_12_terminal {
    server laravel-12:7012;
}

upstream lumen_10_terminal {
    server lumen-10:7110;
}

upstream lumen_11_terminal {
    server lumen-11:7111;
}

upstream lumen_12_terminal {
    server lumen-12:7112;
}

server {
    listen 80;
    server_name localhost;

    # Main sandbox app
    location / {
        proxy_pass http://sandbox_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket for main app
    location /ws {
        proxy_pass http://sandbox_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Laravel 10 routes
    location /laravel/10 {
        rewrite ^/laravel/10(.*)$ /sandbox.html?version=laravel-10 break;
        proxy_pass http://sandbox_app;
    }

    location /terminal/laravel-10 {
        proxy_pass http://laravel_10_terminal/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Laravel 11 routes
    location /laravel/11 {
        rewrite ^/laravel/11(.*)$ /sandbox.html?version=laravel-11 break;
        proxy_pass http://sandbox_app;
    }

    location /terminal/laravel-11 {
        proxy_pass http://laravel_11_terminal/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Laravel 12 routes
    location /laravel/12 {
        rewrite ^/laravel/12(.*)$ /sandbox.html?version=laravel-12 break;
        proxy_pass http://sandbox_app;
    }

    location /terminal/laravel-12 {
        proxy_pass http://laravel_12_terminal/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Lumen 10 routes
    location /lumen/10 {
        rewrite ^/lumen/10(.*)$ /sandbox.html?version=lumen-10 break;
        proxy_pass http://sandbox_app;
    }

    location /terminal/lumen-10 {
        proxy_pass http://lumen_10_terminal/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Lumen 11 routes
    location /lumen/11 {
        rewrite ^/lumen/11(.*)$ /sandbox.html?version=lumen-11 break;
        proxy_pass http://sandbox_app;
    }

    location /terminal/lumen-11 {
        proxy_pass http://lumen_11_terminal/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Lumen 12 routes
    location /lumen/12 {
        rewrite ^/lumen/12(.*)$ /sandbox.html?version=lumen-12 break;
        proxy_pass http://sandbox_app;
    }

    location /terminal/lumen-12 {
        proxy_pass http://lumen_12_terminal/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Static file serving
    location /static {
        proxy_pass http://sandbox_app;
        proxy_cache_valid 200 1d;
        expires 1d;
    }

    # CSS files
    location /css {
        proxy_pass http://sandbox_app;
        proxy_cache_valid 200 1d;
        expires 1d;
    }

    # JS files
    location /js {
        proxy_pass http://sandbox_app;
        proxy_cache_valid 200 1d;
        expires 1d;
    }
}